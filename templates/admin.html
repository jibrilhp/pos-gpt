<!DOCTYPE html>
<html>

<head>
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .search-box {
      margin-bottom: 1rem;
    }

    .table-responsive {
      max-height: 75vh;
      overflow-y: auto;
    }

    th,
    td {
      white-space: nowrap;
    }

    .order-details {
      background-color: #f8f9fa;
      transition: all 0.3s ease;
    }

    .expand-btn {
      cursor: pointer;
    }

    .card {
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 10px;
    }

    .order-items-container {
      padding: 10px;
    }

    .detail-row {
      border-left: 3px solid #6c757d;
    }

    .collapse-btn {
      cursor: pointer;
      padding: 5px;
      color: #0d6efd;
    }

    .menu-item {
      border-bottom: 1px solid #e9ecef;
      padding: 8px 0;
    }

    .menu-item:last-child {
      border-bottom: none;
    }
  </style>
</head>

<body class="p-3">
  <h3 class="mb-4 text-center">üìã Admin Dashboard</h3>

  <!-- Search -->
  <input id="searchInput" class="form-control search-box" type="text" placeholder="Cari nama / HP / catatan..."
    onkeyup="filterTable()">

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped table-hover align-middle text-sm" id="orderTable">
      <thead class="table-dark">
        <tr>
          <th></th>
          <th>Order ID</th>
          <th>Nama</th>
          <th>No. HP</th>
          <th>Catatan</th>
          <th>Status</th>
          <th>Created At</th>
          <th>Update Pembayaran</th>
          <th>Update Status</th>
          <th>Cetak</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders|sort(attribute='created_at', reverse=False) %}
        <tr class="main-row" id="row-{{ order.id }}">
          <td>
            <span class="collapse-btn" onclick="toggleDetails('{{ order.id }}')">
              <i class="bi bi-dash-circle" id="icon-{{ order.id }}"></i>
            </span>
          </td>
          <td>{{ order.id }}</td>
          <td>{{ order.customer }}</td>
          <td>{{ order.phone }}</td>
          <td>{{ order.note }}</td>
          <td><span class="badge bg-secondary">{{ order.status }}</span></td>
          <td>{{ order.created_at }}</td>
          <td>
            <form method="post" action="/mark-paid/{{ order.id }}" class="d-inline">
              {% if not order.is_paid %}
              <button class="btn btn-sm btn-success">Tandai Sudah Dibayar</button>
              {% else %}
              <span class="badge bg-success">Sudah Dibayar</span>
              {% endif %}
            </form>
          </td>
          <td>
            <form method="post" action="/update-status/{{ order.id }}">
              <div class="input-group input-group-sm">
                <select name="status" class="form-select">
                  <option {% if order.status=="Menunggu Konfirmasi" %}selected{% endif %}>Menunggu Konfirmasi</option>
                  <option {% if order.status=="Diproses" %}selected{% endif %}>Diproses</option>
                  <option {% if order.status=="Sudah Siap" %}selected{% endif %}>Sudah Siap</option>
                  <option {% if order.status=="Selesai" %}selected{% endif %}>Selesai</option>
                </select>
                <button class="btn btn-primary" type="submit">OK</button>
              </div>
            </form>
          </td>
          <td>
            <a href="/receipt/{{ order.id }}" target="_blank" class="btn btn-sm btn-secondary">
              üñ®Ô∏è Cetak Struk
            </a>
          </td>
        </tr>

        <!-- Expandable Details Row -->
        <tr class="detail-row" id="details-{{ order.id }}">
          <td colspan="10" class="p-0">
            <div class="card border-0 m-2">
              <div class="card-header bg-light">
                <strong>Detail Pesanan #{{ order.id }}</strong>
              </div>
              <div class="card-body order-items-container">
                <div class="row">
                  {% for item in order.items %}
                  <div class="col-md-4 mb-2">
                    <div class="card h-100">
                      <div class="card-body menu-item">
                        <h5 class="card-title">{{ item.menu.name }}</h5>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <span class="badge bg-primary">Qty: {{ item.qty }}</span>
                          <span class="text-muted">Rp {{ item.menu.price }}</span>
                        </div>
                        {% if item.note %}
                        <div class="mt-2">
                          <small class="text-muted">Catatan:</small>
                          <p class="mb-0 small">{{ item.note }}</p>
                        </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
              <div class="card-footer bg-light text-end">
                <strong>Total Item: {{ order.items|length }}</strong>
                <strong class="ms-3">Total Harga: Rp {{ order.items|sum(attribute=lambda x: x.menu.price * x.qty)
                  }}</strong>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}

      </tbody>
    </table>
  </div>

  <script>
    function filterTable() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const mainRows = document.querySelectorAll(".main-row");

      mainRows.forEach(row => {
        const text = row.innerText.toLowerCase();
        const orderId = row.id.split('-')[1];
        const detailRow = document.getElementById('details-' + orderId);

        if (text.includes(input)) {
          row.style.display = "";
          if (detailRow.style.display !== "none") {
            detailRow.style.display = "";
          }
        } else {
          row.style.display = "none";
          detailRow.style.display = "none";
        }
      });
    }

    // Function to toggle order details visibility
    function toggleDetails(orderId) {
      const detailsRow = document.getElementById('details-' + orderId);
      const icon = document.getElementById('icon-' + orderId);

      if (detailsRow.style.display === "none") {
        detailsRow.style.display = "";
        icon.classList.remove("bi-plus-circle");
        icon.classList.add("bi-dash-circle");
      } else {
        detailsRow.style.display = "none";
        icon.classList.remove("bi-dash-circle");
        icon.classList.add("bi-plus-circle");
      }
    }

    // Initialize all detail rows to be visible by default
    document.addEventListener('DOMContentLoaded', function () {
      const detailRows = document.querySelectorAll('.detail-row');
      detailRows.forEach(row => {
        row.style.display = "";
      });
    });
  </script>
</body>

</html>